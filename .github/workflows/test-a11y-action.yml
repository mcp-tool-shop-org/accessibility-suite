name: Test Accessibility Action (Integration)

on:
  push:
    branches: [main]
    paths:
      - '.github/actions/a11y-ci/**'
      - '.github/workflows/test-a11y-action.yml'
  pull_request:
    branches: [main]
    paths:
      - '.github/actions/a11y-ci/**'
      - '.github/workflows/test-a11y-action.yml'

jobs:
  test-pass:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install a11y-ci
        run: pip install ./src/a11y-ci

      - name: Create Passing Scorecard
        run: |
          echo '{"meta": {"tool": "test", "version": "1"}, "findings": []}' > pass.json

      - name: Run Action (Pass)
        id: gate
        uses: ./.github/actions/a11y-ci
        with:
          current: pass.json
          fail-on: serious
          # Use console output for testing
          post-comment: true 

      - name: Assert Outcomes
        if: steps.gate.outputs.exit_code != '0'
        run: |
          echo "Expected exit code 0, got ${{ steps.gate.outputs.exit_code }}"
          exit 1
      
      - name: Assert Artifacts
        run: |
          if [ ! -f "${{ steps.gate.outputs.report_json_path }}" ]; then exit 1; fi
          if [ ! -f "${{ steps.gate.outputs.mcp_payload_path }}" ]; then exit 1; fi
          if [ ! -f "${{ steps.gate.outputs.comment_md_path }}" ]; then exit 1; fi
          
          # Check comment content
          if ! grep -q "Accessibility Gate: PASS" "${{ steps.gate.outputs.comment_md_path }}"; then
            echo "Comment does not indicate PASS"
            cat "${{ steps.gate.outputs.comment_md_path }}"
            exit 1
          fi

  test-fail:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install a11y-ci
        run: pip install ./src/a11y-ci

      - name: Create Failing Scorecard
        run: |
          echo '{"meta": {"tool": "test", "version": "1"}, "findings": [{"id": "FAIL", "severity": "serious", "message": "fail"}]}' > fail.json

      - name: Run Action (Fail)
        id: gate
        continue-on-error: true
        uses: ./.github/actions/a11y-ci
        with:
          current: fail.json
          fail-on: serious

      - name: Assert Outcomes
        if: steps.gate.outputs.exit_code != '3'
        run: |
          echo "Expected exit code 3, got ${{ steps.gate.outputs.exit_code }}"
          exit 1

      - name: Assert Comment Content
        run: |
           if ! grep -q "Accessibility Gate: FAIL" "${{ steps.gate.outputs.comment_md_path }}"; then
             echo "Comment does not indicate FAIL"
             exit 1
           fi

name: CI

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "**/*.py"
      - "**/*.ts"
      - "**/*.js"
      - "package.json"
      - "pyproject.toml"
      - "docs/**"
      - ".github/workflows/**"
      - ".github/actions/**"
  pull_request:
    branches: [main]
    paths:
      - "src/**"
      - "**/*.py"
      - "**/*.ts"
      - "**/*.js"
      - "package.json"
      - "pyproject.toml"
      - "docs/**"
      - ".github/workflows/**"
      - ".github/actions/**"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # ── Python projects: a11y-assist, a11y-ci, a11y-lint ──────────────
  python:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project:
          - a11y-assist
          - a11y-ci
          - a11y-lint

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        working-directory: src/${{ matrix.project }}
        run: |
          pip install -e .
          pip install pytest

      - name: Run tests
        working-directory: src/${{ matrix.project }}
        run: |
          pytest --collect-only > /dev/null 2>&1
          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 5 ]; then
            echo "::warning::No tests found for ${{ matrix.project }}."
            exit 0
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Error collecting tests."
            exit 1
          fi
          pytest -v

  # ── Node.js projects: a11y-evidence-engine, a11y-mcp-tools ───────
  nodejs:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project:
          - a11y-evidence-engine
          - a11y-mcp-tools

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: src/${{ matrix.project }}/package-lock.json

      - name: Install dependencies
        working-directory: src/${{ matrix.project }}
        run: npm ci

      - name: Run tests
        working-directory: src/${{ matrix.project }}
        run: npm test

  # ── Integration fixture verification for a11y-ci ──────────────────
  gate-verification:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install a11y-ci
        working-directory: src/a11y-ci
        run: pip install .

      - name: Gate Pass Check
        working-directory: src/a11y-ci
        run: a11y-ci gate --current tests/fixtures/current_ok.json

      - name: Gate Fail Check (JSON Report)
        id: fail_check
        working-directory: src/a11y-ci
        run: |
          set +e
          a11y-ci gate --current tests/fixtures/current_fail.json --format json > report.json
          EXIT_CODE=$?
          set -e

          echo "Exit Code: $EXIT_CODE"
          if [ $EXIT_CODE -ne 3 ]; then
            echo "::error::Expected exit code 3 for partial failure, got $EXIT_CODE"
            exit 1
          fi

          echo "::group::JSON Report"
          cat report.json
          echo "::endgroup::"

      - name: Upload Gate Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: a11y-gate-report
          path: src/a11y-ci/report.json

  # ── Accessibility gate (lint scan + reusable action) ───────────────
  a11y-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Tools (Local)
        run: |
          pip install ./src/a11y-lint
          pip install ./src/a11y-ci

      - name: Generate Scorecard (Scan)
        run: |
          mkdir -p .a11y_artifacts
          a11y-lint scan docs --artifact-dir .a11y_artifacts
          echo "Generated scorecard in .a11y_artifacts/"

      - name: Run Accessibility Gate
        id: gate
        uses: ./.github/actions/a11y-ci
        with:
          artifact-dir: .a11y_artifacts
          baseline: docs/baselines/a11y.scorecard.json
          fail-on: serious
          platform: github

      - name: Post PR Comment
        if: github.event_name == 'pull_request' && (success() || failure())
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const commentPath = '${{ steps.gate.outputs.comment_path }}';
            if (!commentPath || !fs.existsSync(commentPath)) {
              console.log('No comment file to post.');
              return;
            }
            const body = fs.readFileSync(commentPath, 'utf8');
            const marker = '<!-- a11y-ci-sticky-comment -->';
            const fullBody = `${marker}\n${body}`;

            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
            });

            const existing = comments.data.find(c => c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body: fullBody,
              });
              console.log(`Updated comment ${existing.id}`);
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: fullBody,
              });
              console.log('Created new comment');
            }

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-artifacts
          path: .a11y_artifacts/**

  # ── Reusable action integration tests (pass / fail) ───────────────
  test-a11y-action-pass:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install a11y-ci
        run: pip install ./src/a11y-ci

      - name: Create Passing Scorecard
        run: |
          echo '{"meta": {"tool": "test", "version": "1"}, "findings": []}' > pass.json

      - name: Run Action (Pass)
        id: gate
        uses: ./.github/actions/a11y-ci
        with:
          current: pass.json
          fail-on: serious
          post-comment: "true"

      - name: Assert Outcomes
        if: steps.gate.outputs.exit_code != '0'
        run: |
          echo "Expected exit code 0, got ${{ steps.gate.outputs.exit_code }}"
          exit 1

      - name: Assert Artifacts
        run: |
          if [ ! -f "${{ steps.gate.outputs.report_json_path }}" ]; then exit 1; fi
          if [ ! -f "${{ steps.gate.outputs.mcp_payload_path }}" ]; then exit 1; fi
          if [ ! -f "${{ steps.gate.outputs.comment_md_path }}" ]; then exit 1; fi

          if ! grep -q "Accessibility Gate: PASS" "${{ steps.gate.outputs.comment_md_path }}"; then
            echo "Comment does not indicate PASS"
            cat "${{ steps.gate.outputs.comment_md_path }}"
            exit 1
          fi

  test-a11y-action-fail:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install a11y-ci
        run: pip install ./src/a11y-ci

      - name: Create Failing Scorecard
        run: |
          echo '{"meta": {"tool": "test", "version": "1"}, "findings": [{"id": "FAIL", "severity": "serious", "message": "fail"}]}' > fail.json

      - name: Run Action (Fail)
        id: gate
        continue-on-error: true
        uses: ./.github/actions/a11y-ci
        with:
          current: fail.json
          fail-on: serious

      - name: Assert Outcomes
        if: steps.gate.outputs.exit_code != '3'
        run: |
          echo "Expected exit code 3, got ${{ steps.gate.outputs.exit_code }}"
          exit 1

      - name: Assert Comment Content
        run: |
          if ! grep -q "Accessibility Gate: FAIL" "${{ steps.gate.outputs.comment_md_path }}"; then
            echo "Comment does not indicate FAIL"
            exit 1
          fi

  # ── Verify documentation handbooks ─────────────────────────────────
  verify-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify Handbooks
        run: python scripts/verify_handbooks.py

  # ── Update baseline (manual only) ─────────────────────────────────
  update-baseline:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Tools (Local)
        run: |
          pip install ./src/a11y-lint
          pip install ./src/a11y-ci

      - name: Generate Scorecard (Scan)
        run: |
          a11y-lint scan docs --format json > docs/baselines/a11y.scorecard.json

      - name: Commit Baseline
        run: |
          git config --global user.name 'a11y-ci-bot'
          git config --global user.email 'a11y-ci-bot@users.noreply.github.com'

          if git diff --quiet docs/baselines/a11y.scorecard.json; then
            echo "No changes in baseline."
          else
            git add docs/baselines/a11y.scorecard.json
            git commit -m "chore(baseline): update a11y baseline"
            git push
            echo "Baseline updated."
          fi
